<main class="flex-grow container mx-auto px-4 py-8">
    <div class="bg-white p-6 rounded-t-lg shadow-md">
        <h1 id="active-project-title" class="text-2xl font-bold text-gray-800 mb-4">Projet sélectionné</h1>

        {% if projects %}
                <!-- Project Information Section -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Information du projet</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- First column of form fields -->
                        <div class="space-y-4 grid grid-cols-1 md:grid-cols-2">

                            <div>
                                <label for="architect-file" class="block text-sm font-medium text-gray-700">Dossier Architecte</label>
                                <input type="text" id="architect-file" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="project-name" class="block text-sm font-medium text-gray-700">Projet</label>
                                <input type="text" id="project-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="project-owner" class="block text-sm font-medium text-gray-700">Maitre de l'ouvrage</label>
                                <input type="text" id="project-owner" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="contractor" class="block text-sm font-medium text-gray-700">Entrepreneur</label>
                                <input type="text" id="contractor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="visit-number" class="block text-sm font-medium text-gray-700">Visite no.</label>
                                <input type="text" id="visit-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="visit-by" class="block text-sm font-medium text-gray-700">Visite effectuée par</label>
                                <input type="text" id="visit-by" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="in-presence-of" class="block text-sm font-medium text-gray-700">En présence de</label>
                                <input type="text" id="in-presence-of" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                             <div>
                                <label for="visit-date" class="block text-sm font-medium text-gray-700">Le</label>
                                <input type="date" id="visit-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                             <div>
                                <label for="report-date" class="block text-sm font-medium text-gray-700">Date du rapport</label>
                                <input type="date" id="report-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>

                        </div>


                        <!-- Second column of form fields -->
                        <div class="space-y-4">
                            <!-- Project Image Upload at the top of second column -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Image du projet</label>
                                <div class="mt-1">
                                    <div id="project-image-preview" class="w-full h-60 bg-gray-100 flex items-center justify-center border border-gray-300 rounded-md overflow-hidden">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <button type="button" id="upload-image-btn" class="mt-2 w-full bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        Upload
                                    </button>
                                    <input type="file" id="project-image-upload" accept="image/*" class="hidden">
                                </div>
                            </div>

                            <!-- Data persistence status -->
                            <div id="data-status" class="mt-4 hidden">
                                <div class="p-2 rounded-md bg-blue-50 text-blue-800 text-sm">
                                    <span id="last-saved-text">Chargement des données</span>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Project Description -->
                    <div class="mt-4">
                        <label for="project-description" class="block text-sm font-medium text-gray-700">Description du projet</label>
                        <textarea id="project-description" rows="3" class="resize-none mt-1 block w-full h-20 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label for="distribution" class="block text-sm font-medium text-gray-700">Distribution</label>
                        <textarea type="text" id="distribution" class="resize-none mt-1 h-60 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Save Button -->
                    <div class="mt-6 flex space-x-4">
                        <button type="button" id="save-project-info" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Enregistrer
                        </button>
                        <button type="button" id="clear-project-info" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                            Tout supprimer
                        </button>
                    </div>
                </div>
        {% else %}
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <p class="text-yellow-700">No projects found. Please check your API connection.</p>
            </div>
        {% endif %}
    </div>

<hr class="w-[95%] h-1.5 bg-black border-0 mx-auto mt-[-0.75rem] relative z-10" />

    <!-- General notes -->
    <div class="bg-white p-6 shadow-md ">
        {% if projects %}
            <div class="gap-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Notes générales</h2>

                <div class=" p-4 grid-cols-1">

                    <p class="text-gray-700 font-medium ">A. Observations</p>
                    <div class="prose prose-sm text-gray-600">
                        <p class="text-gray-700 font-medium">Généralités : </p> <p> Les éléments listés ci-dessous documentent l’état général d’avancement du chantier et ils ne nécessitent donc aucun suivi de la part de l’Entrepreneur.</p>
                    </div>

                    <p class="text-gray-700 font-medium mt-4">B. Instructions</p>
                    <div class="prose prose-sm text-gray-600">
                        <p class="text-gray-700 font-medium ">Généralités : </p><p> Les éléments listés ci-dessous documentent les instructions données à l’Entrepreneur et ils nécessitent donc un suivi de sa part.</p>
                    </div>

                    <p class="text-gray-700 font-medium mt-4">C. Déficiences</p>
                    <div class="prose prose-sm text-gray-600">
                        <p class="text-gray-700 font-medium ">Généralités : </p><p>La liste de Déficiences ci-dessous est non-limitative et ne relève pas l'Entrepreneur et ses Soustraitants
de leurs responsabilités de se conformer aux exigences des plans, devis et autres Documents contractuels
et notamment en ce qui concerne la complétion de l'Ouvrage. En outre, elle doit être complétée par celles des
autres Professionnels concernés.</p>
                        <p class="text-gray-700 font-medium mt-2">Procédure : </p><p>Les Déficiences doivent être corrigés dans les dix (10) jours ouvrables suivant la réception du présent
document. Le surintendant de l'Entrepreneur doit traiter les Déficiences sur cette liste et la faire suivre à l'Architecte
dès que les travaux correctifs ont été effectués. Aucune retenue monétaire ne sera libérée tant et aussi longtemps
que les Déficiences n’auront été entièrement et
parfaitement corrigées.</p>
                        <p class="text-gray-700 font-medium mt-2">Honoraires supplémentaires : </p><p>Après la Réception provisoire de l’ouvrage, l’Architecte prévoit une seule visite
pour procéder à l'acceptation finale des travaux correctifs et il facturera, au Maître de l’ouvrage, des honoraires
supplémentaires de 1 000 $/visite supplémentaire. Le montant total des honoraires supplémentaire sera prélevé
par le Maître de l’ouvrage à même les sommes dues à
l'Entrepreneur en vertu de son Contrat. L'Entrepreneur est responsable de s'assurer que toutes les Déficiences,
incluant celles de ses Sous-traitants et de ses Fournisseurs, ont bel et bien été
entièrement et parfaitement corrigées. </p>
                        <p class="text-gray-700 font-medium mt-2">Classement des couleurs des pastilles : </p><p> Bleu (posée) : nouvelle observation/instruction/déficience constatée par l'Architecte.</p>
                                                                                                               <p>  Rouge / orange (posée) : observation/instruction/déficience d'une visite précédente.</p>
                                                                                                             <p>    Mauve (traitée) : déficience traitée par l'entrepreneur, prête à être validée par l'Architecte.</p>
                                                                                                              <p>   Noir (refusée) : correction de déficience refusée par l'Architecte, à corriger de nouveau, adéquatement.</p>
                                                                                                              <p>   Gris (levée) : déficience dont la correction est approuvée par l'Architecte.</p>
                    </div>

                </div>
            </div>
        {% else %}
             <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            </div>
        {% endif %}
    </div>

    <hr class="w-[95%] h-1.5 bg-black border-0 mx-auto mt-[-0.75rem] relative z-10" />

    <!-- Observations -->
    <div class="bg-white p-6 shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-1">1 - Observations</h2>
        <div id="observations-container" class="mt-1">
            <p class="text-gray-600">Sélectionnez un projet pour voir les observations.</p>
        </div>
    </div>

    <hr class="w-[95%] h-1.5 bg-black border-0 mx-auto mt-[-0.75rem] relative z-10" />

    <!-- instructions -->
    <div class="bg-white p-6 shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-1">2 - Instructions</h2>
        <div id="instructions-container" class="mt-1">
            <p class="text-gray-600">Sélectionnez un projet pour voir les instructions.</p>
        </div>
    </div>

    <hr class="w-[95%] h-1.5 bg-black border-0 mx-auto mt-[-0.75rem] relative z-10" />

    <!-- Déficiences -->
    <div class="bg-white p-6 rounded-b-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-1">3 - Déficiences</h2>
        <div id="deficiencies-container" class="mt-1">
            <p class="text-gray-600">Sélectionnez un projet pour voir les déficiences.</p>
        </div>
    </div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - main.html script running');

        // Add event listener for image upload button
        const uploadBtn = document.getElementById('upload-image-btn');
        const fileInput = document.getElementById('project-image-upload');
        const imagePreview = document.getElementById('project-image-preview');

        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Clear previous content
                        imagePreview.innerHTML = '';

                        // Create and append image
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-full h-full object-cover';
                        imagePreview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }


    // Below functions are kept for future issue functionality
    // Load issues for a project
    function loadIssues(projectId) {
        currentProjectId = projectId;

        // Show issues container
        document.getElementById('issues-container').classList.remove('hidden');

        // Update title
        document.getElementById('issues-title').textContent = 'Loading issues...';

        // Clear previous issues
        document.getElementById('issues-list').innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div></div>';

        // Fetch issues from the API
        fetch(`/api/projects/${projectId}/issues/`)
            .then(response => response.json())
            .then(data => {
                // Update title
                document.getElementById('issues-title').textContent = `Project Issues (${data.issues.length})`;

                // Render issues
                renderIssues(data.issues);

                // Get the project name and update active project
                const searchInput = document.getElementById('search-dropdown');
                if (searchInput) {
                    updateActiveProject(searchInput.value);
                }
            })
            .catch(error => {
                document.getElementById('issues-list').innerHTML = `<div class="text-red-600 text-center py-4">Failed to load issues: ${error.message}</div>`;
            });
    }

    // Remaining functions from original main.html are kept unchanged
    function renderIssues(issues) {
        // Existing function, unchanged
        const issuesList = document.getElementById('issues-list');

        if (issues.length === 0) {
            issuesList.innerHTML = '<div class="text-gray-600 text-center py-4">No issues found for this project</div>';
            return;
        }

        let html = '';

        issues.forEach(issue => {
            // Determine status color
            let statusColor = 'bg-gray-100 text-gray-800';
            if (issue.status === 'open') {
                statusColor = 'bg-yellow-100 text-yellow-800';
            } else if (issue.status === 'closed') {
                statusColor = 'bg-green-100 text-green-800';
            }

            html += `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow issue-item" data-status="${issue.status || 'unknown'}">
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-semibold text-gray-800">${issue.title || 'Untitled Issue'}</h3>
                        <span class="px-2 py-1 rounded-full text-xs ${statusColor}">${issue.status || 'Unknown'}</span>
                    </div>

                    <p class="text-gray-600 text-sm mt-2 line-clamp-2">${issue.description || 'No description'}</p>

                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-gray-500 text-xs">ID: ${issue.id}</span>
                        <button
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                            onclick="viewIssueDetails(${currentProjectId}, ${issue.id})"
                        >
                            View Details
                        </button>
                    </div>
                </div>
            `;
        });

        issuesList.innerHTML = html;
    }

    function filterIssues(status) {
        // Existing function, unchanged
        const issues = document.querySelectorAll('.issue-item');

        issues.forEach(issue => {
            if (status === 'all' || issue.dataset.status === status) {
                issue.classList.remove('hidden');
            } else {
                issue.classList.add('hidden');
            }
        });
    }

    function hideIssues() {
        // Existing function, unchanged
        document.getElementById('issues-container').classList.add('hidden');
        currentProjectId = null;
    }

    function viewIssueDetails(projectId, issueId) {
        // Existing function, unchanged
        // Show modal
        document.getElementById('issue-modal').classList.remove('hidden');

        // Show loading
        document.getElementById('modal-content').innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div></div>';

        // Fetch issue details from the API
        fetch(`/api/projects/${projectId}/issues/${issueId}/`)
            .then(response => response.json())
            .then(issue => {
                // Update modal title
                document.getElementById('modal-title').textContent = issue.title || 'Issue Details';

                // Format created date
                const createdDate = issue.created_at ? new Date(issue.created_at).toLocaleDateString() : 'Unknown';

                // Render issue details
                let html = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Status</h4>
                            <p class="text-gray-800">${issue.status || 'Unknown'}</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Created</h4>
                            <p class="text-gray-800">${createdDate}</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Description</h4>
                            <p class="text-gray-800">${issue.description || 'No description'}</p>
                        </div>
                `;

                // Add assignee if available
                if (issue.assignee) {
                    html += `
                        <div>
                            <h4 class="text-sm font-medium text-gray-500">Assigned To</h4>
                            <p class="text-gray-800">${issue.assignee.name || issue.assignee}</p>
                        </div>
                    `;
                }

                html += '</div>';

                document.getElementById('modal-content').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('modal-content').innerHTML = `<div class="text-red-600">Failed to load issue details: ${error.message}</div>`;
            });
    }

    function closeModal() {
        // Existing function, unchanged
        document.getElementById('issue-modal').classList.add('hidden');
    }

    // Close modal when clicking outside
    document.getElementById('issue-modal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeModal();
        }
    });
</script>